<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: #F8FAFC;
        }

        .auth-card {
            width: 100%;
            max-width: 450px;
            background: white;
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        @media (max-width: 480px) {
            .auth-card {
                padding: 25px;
                border-radius: 20px;
            }

            .auth-container {
                padding: 10px;
            }
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #recaptcha-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>

    <nav class="glass-nav">
        <a href="index.html" class="logo-container">
            <div class="logo-box">Ø¨</div>
            <div style="font-weight: 900; font-size: 18px;">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
        </a>
    </nav>

    <div class="auth-container">
        <!-- Step 1: Login -->
        <div id="login-step" class="auth-card step active">
            <div class="text-center mb-2">
                <div
                    style="width: 70px; height: 70px; background: white; border: 2px solid var(--gold); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px; color: var(--gold);">
                    ğŸ—ï¸</div>
                <h2 style="font-weight: 900; font-size: 1.8rem;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
            </div>
            <form id="login-form" style="margin-top: 30px;">
                <div id="error-msg"
                    style="display: none; padding: 12px; background: #fee2e2; color: #dc2626; border-radius: 12px; font-size: 0.8rem; font-weight: 800; margin-bottom: 20px; text-align: center;">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="text" id="phone" class="form-input" placeholder="09xxxxxxxx" required>
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <div id="recaptcha-container"></div>
                <button type="submit" id="login-btn" class="btn btn-primary" style="width: 100%; padding: 18px;">Ù…ØªØ§Ø¨Ø¹Ø©
                    ğŸ”’</button>
            </form>
            <div class="text-center mt-4">
                <button onclick="goToReset()"
                    style="background: none; border: none; color: var(--gold); font-weight: 800; cursor: pointer; font-size: 0.85rem;">Ù†Ø³ÙŠØª
                    ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
            </div>

            <hr style="margin: 25px 0; border: none; border-top: 1px solid rgba(0,0,0,0.05);">

            <div class="text-center">
                <p style="font-size: 0.9rem; font-weight: 700; color: #64748B; margin-bottom: 15px;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</p>
                <a href="register.html" class="btn btn-outline"
                    style="width: 100%; justify-content: center; padding: 15px;">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯ âœ¨</a>
                <a href="register.html?mode=doctor"
                    style="display: block; margin-top: 15px; color: var(--gold); font-weight: 800; font-size: 0.85rem; text-decoration: none;">
                    ğŸ‘¨â€âš•ï¸ Ù„Ù„Ø£Ø·Ø¨Ø§Ø¡: Ø§Ù†Ø¶Ù… Ù„ÙØ±ÙŠÙ‚Ù†Ø§ Ø§Ù„Ø·Ø¨ÙŠ
                </a>
            </div>
        </div>

        <!-- Step 2: OTP (Universal) -->
        <div id="otp-step" class="auth-card step">
            <div class="text-center mb-2">
                <div style="font-size: 50px; margin-bottom: 20px;">ğŸ“±</div>
                <h2 style="font-weight: 900; font-size: 1.8rem;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ©</h2>
                <p style="color: #64748B; font-weight: 700; margin-top: 10px;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ
                </p>
            </div>
            <form id="otp-form" style="margin-top: 30px;">
                <div class="form-group">
                    <input type="text" id="otp-input" class="form-input text-center" maxlength="6"
                        style="letter-spacing: 12px; font-size: 1.5rem;" placeholder="000000" required>
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; padding: 18px; background: #16a34a;">ØªØ­Ù‚Ù‚ ÙˆØªÙƒÙ…Ù„Ø© âœ…</button>
            </form>
        </div>

        <!-- Step 3: Password Reset -->
        <div id="reset-step" class="auth-card step">
            <div class="text-center mb-2">
                <div style="font-size: 50px; margin-bottom: 20px;">ğŸ”„</div>
                <h2 style="font-weight: 900; font-size: 1.8rem;">ØªØ¬Ø¯ÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
                <p style="color: #64748B; font-weight: 700; margin-top: 10px;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨Ùƒ</p>
            </div>
            <form id="reset-form" style="margin-top: 30px;">
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <input type="password" id="new-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 18px;">Ø­ÙØ¸ ÙˆØªØºÙŠÙŠØ± ğŸ’¾</button>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentFlow = 'LOGIN'; // 'LOGIN' or 'RESET'
        let targetUserPhone = '';
        let pendingUser = null;
        let pendingToken = null;

        function showStep(id) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function goToReset() {
            const phone = document.getElementById('phone').value;
            if (!phone) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹'); return; }
            const user = Store.getUsers().find(u => u.phone === phone);
            if (!user) { alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø³Ø¬Ù„'); return; }

            targetUserPhone = phone;
            currentFlow = 'RESET';

            const btn = document.getElementById('login-btn');
            btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...';
            btn.disabled = true;

            const res = await Auth.sendOTP(phone, 'recaptcha-container');
            if (res.success) {
                showStep('otp-step');
            } else {
                alert(res.message);
                btn.disabled = false;
                btn.innerText = 'Ù…ØªØ§Ø¨Ø¹Ø© ğŸ”’';
            }
        }

        document.getElementById('login-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            const res = await Auth.login(phone, password);

            if (res.success) {
                pendingUser = res.user;
                pendingToken = res.token;
                targetUserPhone = phone;
                currentFlow = 'LOGIN';

                const btn = document.getElementById('login-btn');
                btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...';
                btn.disabled = true;

                const otpRes = await Auth.sendOTP(phone, 'recaptcha-container');
                if (otpRes.success) {
                    showStep('otp-step');

                    // Auto-fill OTP if simulated
                    if (otpRes.simulated && otpRes.code) {
                        const otpInput = document.getElementById('otp-input');
                        setTimeout(() => {
                            otpInput.value = otpRes.code;
                            // Trigger submit automatically after 1 second
                            setTimeout(() => {
                                document.getElementById('otp-form').dispatchEvent(new Event('submit'));
                            }, 1000);
                        }, 800);
                    }
                } else {
                    alert(otpRes.message);
                    btn.disabled = false;
                    btn.innerText = 'Ù…ØªØ§Ø¨Ø¹Ø© ğŸ”’';
                }
            } else {
                const err = document.getElementById('error-msg');
                err.style.display = 'block';
                err.innerText = res.message;
            }
        });

        document.getElementById('otp-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const code = document.getElementById('otp-input').value;
            const verifyRes = await Auth.verifyOTP(code);

            if (verifyRes.success) {
                if (currentFlow === 'LOGIN') {
                    Auth.finalizeLogin(pendingUser, pendingToken);
                    window.location.href = 'dashboard.html';
                } else {
                    showStep('reset-step');
                }
            } else {
                alert(verifyRes.message || 'Ø±Ù…Ø² Ø§Ù„ØªØ£ÙƒÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­');
            }
        });

        document.getElementById('reset-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const pass = document.getElementById('new-password').value;
            if (Auth.resetPassword(targetUserPhone, pass)) {
                alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
                location.reload();
            }
        });
    </script>
</body>

</html>