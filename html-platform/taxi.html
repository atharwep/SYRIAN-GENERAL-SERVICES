<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø¬Ø² ØªÙƒØ³ÙŠ - Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .taxi-map-container {
            position: relative;
            width: 100%;
            height: 350px;
            background: #0f1015;
            border-radius: 30px;
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid var(--border-rgba);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-grid {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image:
                radial-gradient(circle, rgba(197, 160, 33, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: mapPulse 10s linear infinite;
        }

        @keyframes mapPulse {
            from {
                transform: translate(-20px, -20px);
            }

            to {
                transform: translate(0, 0);
            }
        }

        .driver-card-mini {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-rgba);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 12px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .driver-card-mini:hover {
            background: rgba(197, 160, 33, 0.05);
            transform: scale(1.02);
        }

        .status-badge {
            font-size: 0.65rem;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 8px;
            text-transform: uppercase;
        }

        .status-available {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-busy {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .search-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 11, 16, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
        }

        .radar {
            width: 80px;
            height: 80px;
            border: 4px solid var(--gold);
            border-radius: 50%;
            position: relative;
            margin-bottom: 20px;
            animation: radarPing 1.5s ease-out infinite;
        }

        @keyframes radarPing {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="royal-dark">
    <nav class="glass-nav">
        <a href="index.html" class="logo-container">
            <div class="logo-box">
                <img src="assets/logo.png" alt="Moamalaty">
            </div>
            <div>
                <div style="font-weight: 950; font-size: 20px; color: white;">ØªÙƒØ³ÙŠ <span
                        style="font-size: 12px; color: var(--gold);">Moamalaty Taxi</span></div>
                <div style="font-size: 8px; color: var(--gold); font-weight: 800; letter-spacing: 1px;">PREMIUM
                    TRANSPORT</div>
            </div>
        </a>
        <div id="nav-right"></div>
    </nav>
    <main class="container" style="padding-top: 20px;">
        <div class="taxi-map-container">
            <div class="map-grid"></div>
            <div class="search-overlay" id="search-overlay">
                <div class="radar"></div>
                <h3 style="color: white; font-weight: 950;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ø£Ø³Ø±Ø¹ ÙƒØ§Ø¨ØªÙ† Ù„Ùƒ</p>
            </div>

            <div style="position: absolute; bottom: 20px; left: 20px; right: 20px; z-index: 10;">
                <div class="card"
                    style="padding: 15px; background: rgba(10, 11, 16, 0.95); backdrop-filter: blur(10px); border: 1px solid var(--gold);">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <input type="text" id="pickup" class="form-input" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)..."
                            style="font-size: 0.85rem; padding: 12px; background: rgba(255,255,255,0.05);">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <input type="text" id="destination" class="form-input" placeholder="Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ°Ù‡Ø¨ØŸ"
                            style="font-size: 0.85rem; padding: 12px; background: rgba(255,255,255,0.05);">
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-3" style="gap: 15px; margin-top: 20px;">
            <div class="option-card" onclick="selectType('BASIC')" id="type-BASIC"
                style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 15px; border: 1px solid var(--border-rgba); cursor: pointer; text-align: center;">
                <i class="fas fa-car" style="font-size: 20px; color: var(--gold); margin-bottom: 8px;"></i>
                <p style="font-size: 0.8rem; font-weight: 900; color: white; margin: 0;">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</p>
            </div>
            <div class="option-card active" onclick="selectType('VIP')" id="type-VIP"
                style="background: rgba(197, 160, 33, 0.1); padding: 15px; border-radius: 15px; border: 1px solid var(--gold); cursor: pointer; text-align: center;">
                <i class="fas fa-crown" style="font-size: 20px; color: var(--gold); margin-bottom: 8px;"></i>
                <p style="font-size: 0.8rem; font-weight: 900; color: white; margin: 0;">Ù…Ù„ÙƒÙŠØ© (VIP)</p>
            </div>
            <div class="option-card" onclick="selectType('LARGE')" id="type-LARGE"
                style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 15px; border: 1px solid var(--border-rgba); cursor: pointer; text-align: center;">
                <i class="fas fa-van-shuttle" style="font-size: 20px; color: var(--gold); margin-bottom: 8px;"></i>
                <p style="font-size: 0.8rem; font-weight: 900; color: white; margin: 0;">Ø¹Ø§Ø¦Ù„ÙŠØ©</p>
            </div>
        </div>

        <button class="btn btn-primary" onclick="startSearch()"
            style="width: 100%; margin-top: 30px; padding: 20px; font-size: 1.1rem; border-radius: 25px;">
            Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù† <i class="fas fa-bolt" style="margin-right: 10px;"></i>
        </button>
        </div>
    </main>

    <aside>
        <div class="card" style="height: 100%;">
            <h3
                style="font-weight: 950; color: white; margin-bottom: 25px; border-bottom: 1px solid var(--border-rgba); padding-bottom: 15px;">
                Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙØ±ÙˆÙ†</h3>
            <div id="drivers-list">
                <!-- Dynamic -->
                <div style="text-align: center; color: var(--text-muted); padding: 50px 0;">
                    <i class="fas fa-satellite" style="font-size: 30px; margin-bottom: 15px;"></i>
                    <p style="font-weight: 700; font-size: 0.85rem;">Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</p>
                </div>
            </div>

            <div
                style="margin-top: 30px; padding: 20px; background: rgba(197, 160, 33, 0.05); border-radius: 20px; border: 1px dashed var(--gold);">
                <p style="color: var(--gold); font-size: 0.75rem; font-weight: 800; line-height: 1.6; margin: 0;">
                    ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©. Ø§Ù„Ø¯ÙØ¹ ÙŠØªÙ… Ù†Ù‚Ø¯Ø§Ù‹ Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ
                    Ø¹Ø¨Ø± Ù…Ø­ÙØ¸ØªÙƒ Ø§Ù„Ù…Ù„ÙƒÙŠØ©.
                </p>
            </div>
        </div>
    </aside>
    </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let selectedType = 'VIP';

        document.addEventListener('DOMContentLoaded', async () => {
            await renderDrivers();
            detectLocation();
        });

        // ... detectLocation and selectType stay mostly same ...

        async function renderDrivers() {
            const list = document.getElementById('drivers-list');
            const res = await FirebaseDB.taxis.getAll();
            const drivers = res.data || [];

            if (drivers.length === 0) {
                list.innerHTML = `<p style="text-align:center; color:gray; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù†Ø´Ø·ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
                return;
            }

            list.innerHTML = drivers.map(d => `
                <div class="driver-card-mini">
                    <img src="${d.avatar || 'assets/nuser.png'}" style="width: 45px; height: 45px; border-radius: 12px; border: 2px solid var(--border-rgba);">
                    <div style="flex: 1;">
                        <h5 style="color: white; font-weight: 900; margin: 0; font-size: 0.85rem;">${d.name}</h5>
                        <p style="color: var(--text-muted); font-size: 0.65rem; font-weight: 700; margin: 2px 0;">${d.carType} â€¢ ${d.carPlate}</p>
                        <p style="color: var(--gold); font-size: 0.65rem; font-weight: 800;">â­ ${d.rating || 5} (${d.trips || 0} Ø±Ø­Ù„Ø©)</p>
                    </div>
                    <span class="status-badge ${d.status === 'AVAILABLE' ? 'status-available' : 'status-busy'}">
                        ${d.status === 'AVAILABLE' ? 'Ù…ØªÙˆÙØ±' : 'Ù…Ø´ØºÙˆÙ„'}
                    </span>
                </div>
            `).join('');
        }

        async function startSearch() {
            const dest = document.getElementById('destination').value;
            if (!dest) {
                Notify.show("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹", "fas fa-warning");
                return;
            }

            document.getElementById('search-overlay').style.display = 'flex';

            const res = await FirebaseDB.taxis.getAll();
            const drivers = (res.data || []).filter(d => d.status === 'AVAILABLE');

            setTimeout(() => {
                if (drivers.length > 0) {
                    const bestDriver = drivers[0];
                    document.getElementById('search-overlay').innerHTML = `
                        <div style="background: var(--bg-dark); padding: 30px; border-radius: 30px; border: 2px solid var(--gold); max-width: 320px;">
                            <img src="${bestDriver.avatar || 'assets/nuser.png'}" style="width: 80px; height: 80px; border-radius: 20px; border: 3px solid var(--gold); margin-bottom: 15px;">
                            <h3 style="color: white; font-weight: 950; margin-bottom: 10px;">ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">Ø§Ù„ÙƒØ§Ø¨ØªÙ† ${bestDriver.name} Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ùƒ</p>
                            <button class="btn btn-primary" onclick="proceedToOrder('${bestDriver.phone}')" style="width: 100%; border-radius: 15px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
                        </div>
                    `;
                } else {
                    document.getElementById('search-overlay').innerHTML = `
                        <div style="background: var(--bg-dark); padding: 30px; border-radius: 30px; border: 2px solid #ef4444; max-width: 320px;">
                            <i class="fas fa-times-circle" style="font-size: 50px; color: #ef4444; margin-bottom: 15px;"></i>
                            <h3 style="color: white; font-weight: 950; margin-bottom: 10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªÙˆØ³ÙŠØ¹ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø«ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.</p>
                            <button class="btn" onclick="location.reload()" style="width: 100%; background: #334155; color: white; border-radius: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    `;
                }
            }, 2000);
        }

        async function proceedToOrder(driverPhone) {
            const newOrder = {
                userPhone: Store.user.phone,
                driverPhone: driverPhone,
                status: 'PENDING',
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                type: selectedType
            };

            const res = await FirebaseDB.orders.create(newOrder);
            if (res.success) {
                window.location.href = `taxi-order.html?id=${res.id}`;
            } else {
                alert("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø«Ø§Ù†ÙŠØ©");
            }
        }
    </script>
</body>

</html>