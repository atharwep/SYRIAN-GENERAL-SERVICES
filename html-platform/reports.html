<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .metric-title {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 900;
            color: #0f172a;
        }

        .metric-trend {
            font-size: 0.8rem;
            color: #10b981;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            text-align: right;
            color: #64748b;
            padding: 15px;
            font-size: 0.8rem;
            border-bottom: 2px solid #f1f5f9;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
    </style>
</head>

<body style="background: #f8fafc;">

    <!-- Navbar -->
    <nav class="glass-nav">
        <div style="display:flex; align-items:center; gap:15px;">
            <a href="dashboard.html" class="btn btn-outline">Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
            <h2 style="font-weight:900;">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
        </div>
        <button onclick="window.print()" class="btn btn-primary">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </nav>

    <div class="container" style="padding-top: 40px; padding-bottom: 100px;">

        <!-- Summary Cards -->
        <div class="grid grid-3">
            <div class="report-card">
                <div class="metric-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ø§Ù„ØµØ§ÙÙŠØ©)</div>
                <div class="metric-value" id="total-profit">$0.00</div>
                <div class="metric-trend">ğŸ“ˆ +0% Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
            </div>
            <div class="report-card">
                <div class="metric-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                <div class="metric-value" id="total-txs">0</div>
                <div class="metric-trend">Ø­Ø±ÙƒØ© Ù…Ø§Ù„ÙŠØ© Ù†Ø´Ø·Ø©</div>
            </div>
            <div class="report-card">
                <div class="metric-title">Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªØ¬Ø²</div>
                <div class="metric-value" id="total-held">$0.00</div>
                <div class="metric-trend">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-2" style="margin-top: 20px;">
            <div class="report-card">
                <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                <canvas id="txChart"></canvas>
            </div>
            <div class="report-card">
                <h3>Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¯Ø®Ù„</h3>
                <canvas id="incomeChart"></canvas>
            </div>
        </div>

        <!-- Detailed Ledger -->
        <div class="report-card">
            <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
            <div class="table-container">
                <table id="ledger-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Injected JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check Admin Auth
            if (!Store.user || (Store.user.role !== 'ADMIN' && Store.user.role !== 'PARTNER')) {
                // Determine if partner role exists, else default admin check
                // Just strictly check ADMIN for now as per dashboard button
                if (Store.user.role !== 'ADMIN') {
                    alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
                    window.location.href = 'index.html';
                    return;
                }
            }

            loadReportData();
        });

        function loadReportData() {
            const txs = Store.getData('transactions') || [];
            const users = Store.getUsers();

            // 1. Calculate Totals
            let totalVolume = 0;
            let totalProfit = 0; // Usually fees
            let heldBalance = users.reduce((acc, u) => acc + (u.balance || 0), 0);

            // Mocking Profit logic: Assuming 10% fee on "Payment" types or manual deposits
            // For now, assume Profit = 5% of all positive transactions just for demo reporting

            txs.forEach(tx => {
                totalVolume += Math.abs(tx.amount);
            });

            totalProfit = totalVolume * 0.05; // Mock Profit Margin

            // 2. Render KPIs
            document.getElementById('total-profit').innerText = `$${totalProfit.toLocaleString()}`;
            document.getElementById('total-txs').innerText = txs.length;
            document.getElementById('total-held').innerText = `$${heldBalance.toLocaleString()}`;

            // 3. Render Table
            const tbody = document.querySelector('#ledger-table tbody');
            tbody.innerHTML = txs.map(tx => `
                <tr>
                    <td style="font-family:monospace; color:#64748B;">#${tx.id.toString().slice(-6)}</td>
                    <td>${tx.date}</td>
                    <td>${tx.userPhone}</td>
                    <td><span class="status-badge" style="background:${tx.amount > 0 ? '#dcfce7' : '#fee2e2'}; color:${tx.amount > 0 ? '#16a34a' : '#dc2626'}">${tx.title}</span></td>
                    <td style="font-weight:900;">$${Math.abs(tx.amount).toLocaleString()}</td>
                    <td>-</td>
                </tr>
            `).join('');

            // 4. Render Charts
            new Chart(document.getElementById('txChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Ø¥ÙŠØ¯Ø§Ø¹', 'Ø³Ø­Ø¨', 'Ø¯ÙØ¹ Ø®Ø¯Ù…Ø§Øª'],
                    datasets: [{
                        data: [60, 20, 20], // Mock distribution
                        backgroundColor: ['#10b981', '#ef4444', '#3b82f6']
                    }]
                }
            });

            new Chart(document.getElementById('incomeChart'), {
                type: 'bar',
                data: {
                    labels: ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„'],
                    datasets: [{
                        label: 'Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
                        data: [1200, 1900, 3000, 500],
                        backgroundColor: '#2563eb'
                    }]
                }
            });
        }
    </script>
</body>

</html>