<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…Ù„ÙƒÙŠ - Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .medical-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-rgba);
            border-radius: 35px;
            padding: 30px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .vital-badge {
            background: rgba(197, 160, 33, 0.1);
            color: var(--gold);
            padding: 15px 25px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid var(--border-rgba);
        }

        .record-entry {
            border-right: 4px solid var(--gold);
            background: rgba(255, 255, 255, 0.02);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            transition: 0.3s;
        }

        .record-entry:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(-5px);
        }
    </style>
</head>

<body>
    <nav class="glass-nav">
        <a href="dashboard.html" class="logo-container">
            <div class="logo-box"><img src="assets/logo.png" alt="Moamalaty"></div>
            <div>
                <div style="font-weight: 950; font-size: 20px; color: white;">Ù…Ù„ÙÙŠ Ø§Ù„Ø·Ø¨ÙŠ <span
                        style="font-size: 12px; color: var(--gold);">Royal Health</span></div>
                <div style="font-size: 8px; color: var(--gold); font-weight: 800; letter-spacing: 1px;">E2EE SECURED
                    RECORD</div>
            </div>
        </a>
    </nav>

    <div class="container" style="padding-top: 20px;">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
            <div>
                <h1 style="color: white; font-weight: 950; font-size: 2.22rem;">Ø£Ø¶Ø¨Ø§Ø±ØªÙŠ Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© ğŸ©º</h1>
                <p style="color: var(--text-muted); font-weight: 700;">Ø³Ø¬Ù„ Ø·Ø¨ÙŠ Ø´Ø§Ù…Ù„ Ù…ÙˆØ«Ù‚ ÙˆÙ…Ø´ÙØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</p>
            </div>
            <div style="display: flex; gap: 15px;">
                <button onclick="openShareQR()" class="btn btn-primary"
                    style="padding: 12px 25px; border-radius: 15px;">
                    <i class="fas fa-qrcode"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù (QR)
                </button>
            </div>
        </div>

        <div class="grid grid-3" style="margin-bottom: 30px; gap: 20px;">
            <div class="vital-badge">
                <p style="font-size: 0.75rem; font-weight: 800; margin-bottom: 5px; opacity: 0.7;">ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</p>
                <h2 id="blood-type" style="font-weight: 950; font-size: 1.8rem;">O+</h2>
            </div>
            <div class="vital-badge"
                style="border-color: #ef4444; background: rgba(239, 68, 68, 0.05); color: #ef4444;">
                <p style="font-size: 0.75rem; font-weight: 800; margin-bottom: 5px; opacity: 0.7;">Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©</p>
                <h2 id="allergies" style="font-weight: 950; font-size: 1.4rem;">Ø§Ù„Ø¨Ù†Ø³Ù„ÙŠÙ†</h2>
            </div>
            <div class="vital-badge"
                style="border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); color: #3b82f6;">
                <p style="font-size: 0.75rem; font-weight: 800; margin-bottom: 5px; opacity: 0.7;">Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</p>
                <h2 style="font-weight: 950; font-size: 1.4rem;">Ù…Ù†Ø° 3 Ø£ÙŠØ§Ù…</h2>
            </div>
        </div>

        <div class="medical-card">
            <h3 style="font-weight: 900; margin-bottom: 20px; color: var(--gold);"><i class="fas fa-file-medical"></i>
                Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
            <div id="medical-history">
                <div class="record-entry">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 950; color: white;">Ø¯. Ø¹Ù…Ø§Ø± Ø§Ù„Ø­Ù…ÙˆÙŠ - Ø£Ø®ØµØ§Ø¦ÙŠ Ù‚Ù„Ø¨ÙŠØ©</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700;">2024/05/12</span>
                    </div>
                    <p style="color: white; font-weight: 700; opacity: 0.8; line-height: 1.6;">ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ ÙØ­Øµ Ø¯ÙˆØ±ÙŠØŒ Ø§Ù„Ø¶ØºØ·
                        120/80ØŒ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ù„Ø¨ Ù…Ø³ØªÙ‚Ø±Ø© ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§ ÙŠØ¯Ø¹Ùˆ Ù„Ù„Ù‚Ù„Ù‚. ÙŠÙ†ØµØ­ Ø¨Ø§Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„ØµÙˆØ¯ÙŠÙˆÙ….</p>
                </div>
            </div>
            <button class="btn btn-outline" style="width: 100%; margin-top: 15px;">+ Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ</button>
        </div>

        <div class="medical-card">
            <h3 style="font-weight: 900; margin-bottom: 20px; color: #3b82f6;"><i class="fas fa-pills"></i> Ø§Ù„ÙˆØµÙØ§Øª
                Ø§Ù„Ø·Ø¨ÙŠØ© (Prescriptions)</h3>
            <div id="prescriptions-list">
                <div
                    style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="color: white; font-weight: 800; margin-bottom: 5px;">Panadol Extra</h4>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">Ø­Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù„Ø²ÙˆÙ… - Ù„Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹</p>
                    </div>
                    <button class="btn-icon">ğŸ’Š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="modal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(15px);">
        <div class="medical-card" style="max-width: 400px; text-align: center; background: white;">
            <h3 style="color: black; font-weight: 950; margin-bottom: 10px;">Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ›¡ï¸</h3>
            <p style="color: #64748B; font-size: 0.8rem; margin-bottom: 25px; font-weight: 700;">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹
                Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø­ØµØ±Ø§Ù‹</p>
            <div id="qrcode"
                style="display: inline-block; padding: 20px; background: white; border-radius: 20px; border: 1px solid #EEE;">
            </div>
            <p style="color: black; font-weight: 950; margin-top: 20px;" id="patient-name-qr">...</p>
            <button onclick="document.getElementById('qrModal').style.display='none'" class="btn btn-primary"
                style="width:100%; margin-top: 20px;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¢Ù…Ù†</button>
        </div>
    </div>

    <script src="js/medical-core.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Store.user) return window.location.href = 'login.html';
            document.getElementById('patient-name-qr').innerText = Store.user.name;

            // Load real health data
            const patient = await MedicalCore.getPatient(Store.user.id || Store.user.phone);
            if (patient) {
                document.getElementById('blood-type').innerText = patient.blood_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('allergies').innerText = patient.allergies || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

                // Load history
                const records = await MedicalCore.getRecords(patient.id);
                renderRecords(records);
            }
        });

        function renderRecords(records) {
            const list = document.getElementById('medical-history');
            if (!records || records.length === 0) {
                list.innerHTML = '<p style="color:gray; text-align:center; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø·Ø¨ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©</p>';
                return;
            }

            list.innerHTML = records.map(r => `
                <div class="record-entry">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 950; color: white;">${r.doctor_name || 'Ø·Ø¨ÙŠØ¨ Ù…ØªØ®ØµØµ'}</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700;">${new Date(r.visit_date || r.created_at).toLocaleDateString('ar-SY')}</span>
                    </div>
                    <p style="color: white; font-weight: 700; opacity: 0.8; line-height: 1.6;">${r.diagnosis || r.notes}</p>
                </div>
            `).join('');
        }

        async function openShareQR() {
            const modal = document.getElementById('qrModal');
            const qrBox = document.getElementById('qrcode');
            qrBox.innerHTML = '';

            const patient = await MedicalCore.getPatient(Store.user.id || Store.user.phone);
            if (!patient) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ØµØ­ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹");

            const token = await MedicalCore.createShareLink(patient.id);
            const secureLink = `https://muamalati.app/record-viewer.html?token=${token}`;

            new QRCode(qrBox, {
                text: secureLink,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            modal.style.display = 'flex';
        }
    </script>
</body>

</html>