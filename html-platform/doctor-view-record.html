<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ - Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø¶Ø¨Ø§Ø±Ø© - Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="js/config.js"></script>
    <script src="js/security.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/medical-core.js"></script>

    <style>
        .doctor-card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border-rgba);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .form-control:focus {
            border-color: var(--gold);
            outline: none;
        }
    </style>
</head>

<body>
    <nav class="glass-nav">
        <a href="index.html" class="logo-container">
            <div class="logo-box"><img src="assets/logo.png" alt="Logo"></div>
            <div style="font-weight: 950; font-size: 19px; color: white;">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</div>
        </a>
        <div class="nav-links">
            <a href="dashboard.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="patient-record.html">Ø¹Ø±Ø¶ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</a>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px;">
        <h1 style="color: white; font-weight: 950; margin-bottom: 30px;">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„Ù Ù…Ø±ÙŠØ¶ <span
                style="color: var(--gold); font-size: 0.8em;">(Ø¹Ø±Ø¶ Ø·Ø¨ÙŠØ¨)</span></h1>

        <!-- Patient Status Header -->
        <div class="doctor-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 id="p-name" style="color: white; margin: 0 0 5px 0;">Ø¬Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h2>
                    <p style="color: #64748B; margin: 0;">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: <span id="p-id"
                            style="color: var(--gold);">--</span></p>
                </div>
                <div style="text-align: left;">
                    <span
                        style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 5px 12px; border-radius: 50px; font-weight: 800; font-size: 0.8rem;">Ø­Ø³Ø§Ø³ÙŠØ©:
                        <span id="p-allergies">--</span></span>
                    <div style="margin-top: 5px; color: #94a3b8; font-size: 0.8rem;">ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…: <span id="p-blood"
                            style="color: white; font-weight: 900;">--</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-2" style="gap: 20px;">
            <!-- New Diagnosis Form -->
            <div class="doctor-card">
                <h3 style="color: var(--gold); font-weight: 900; margin-bottom: 20px;">âœï¸ Ø¥Ø¶Ø§ÙØ© ØªØ´Ø®ÙŠØµ Ø¬Ø¯ÙŠØ¯</h3>
                <form id="diagnosis-form">
                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
                    <select id="visit-type" class="form-control">
                        <option value="ÙƒØ´ÙÙŠØ© Ø¹Ø§Ø¯ÙŠØ©">ÙƒØ´ÙÙŠØ© Ø¹Ø§Ø¯ÙŠØ© (Ø¹ÙŠØ§Ø¯Ø©)</option>
                        <option value="Ø·ÙˆØ§Ø±Ø¦">Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦</option>
                        <option value="Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¹Ù† Ø¨Ø¹Ø¯">Ø§Ø³ØªØ´Ø§Ø±Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
                        <option value="Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ©">Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ©</option>
                    </select>

                    <label class="form-label">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ</label>
                    <input type="text" id="diagnosis" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªÙ‡Ø§Ø¨ Ø­Ù„Ù‚ Ø­Ø§Ø¯" required>

                    <label class="form-label">Ø§Ù„ÙˆØµÙØ© Ø§Ù„Ø·Ø¨ÙŠØ© / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ</label>
                    <textarea id="prescription" class="form-control" rows="4"
                        placeholder="Ø§Ù„Ø£Ø¯ÙˆÙŠØ©ØŒ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©..." required></textarea>

                    <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© (ØªØ¸Ù‡Ø± Ù„Ù„Ø·Ø¨ÙŠØ¨ ÙÙ‚Ø·)</label>
                    <textarea id="notes" class="form-control" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ©..."></textarea>

                    <button type="submit" class="btn btn-primary"
                        style="width: 100%; padding: 15px; font-weight: 900;">Ø­ÙØ¸ ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„ âœ…</button>
                </form>
            </div>

            <!-- History View -->
            <div class="doctor-card">
                <h3 style="color: white; font-weight: 900; margin-bottom: 20px;">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚</h3>
                <div id="history-list" style="max-height: 500px; overflow-y: auto; padding-right: 5px;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simulate picking a patient (In real app, passed via URL ?patient_id=...)
        // For demo, we default to the dummy patient 'p_1' if no valid user is logged in or if user is doctor viewing himself
        // Just for demo purposes, we fetch the first available patient.

        let currentPatientId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Find a patient
            const patients = JSON.parse(localStorage.getItem(MedicalCore.TABLES.PATIENTS) || '[]');
            const patient = patients[0]; // Logic: Get first patient for demo

            if (patient) {
                currentPatientId = patient.id;
                loadPatientHeader(patient);
                loadHistory(patient.id);
            } else {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹.");
                window.location.href = 'patient-record.html';
            }
        });

        function loadPatientHeader(p) {
            document.getElementById('p-name').innerText = p.full_name;
            document.getElementById('p-id').innerText = "#" + p.id;
            document.getElementById('p-blood').innerText = p.blood_type;
            document.getElementById('p-allergies').innerText = p.allergies;
        }

        function loadHistory(pid) {
            const records = MedicalCore.getRecords(pid);
            const list = document.getElementById('history-list');

            if (records.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>';
                return;
            }

            list.innerHTML = records.map(r => `
                <div style="background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px; margin-bottom: 10px; border-right: 3px solid var(--gold);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gold); font-size: 0.8rem; font-weight: 800;">${new Date(r.created_at).toLocaleDateString()}</span>
                        <span style="color: #94a3b8; font-size: 0.8rem;">${r.doctor_name || 'Ø¯. ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <h4 style="color: white; margin: 0 0 5px 0;">${r.diagnosis}</h4>
                    <p style="color: #cbd5e1; font-size: 0.9rem; margin: 0;">${r.prescription}</p>
                </div>
            `).join('');
        }

        document.getElementById('diagnosis-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentPatientId) return;

            const diagnosis = document.getElementById('diagnosis').value;
            const prescription = document.getElementById('prescription').value;
            const notes = document.getElementById('notes').value;
            const doctorName = Store.user ? Store.user.name : "Ø¯. Ø²Ø§Ø¦Ø±";
            const doctorId = Store.user ? Store.user.id : "doc_guest";

            const newRecord = {
                patient_id: currentPatientId,
                doctor_id: doctorId,
                doctor_name: doctorName, // Storing name for easier display
                diagnosis: diagnosis,
                prescription: prescription,
                notes: notes,
                visit_date: new Date().toISOString()
            };

            MedicalCore.addRecord(newRecord);
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­ âœ…");

            // Reset form
            e.target.reset();
            loadHistory(currentPatientId);
        });
    </script>
</body>

</html>