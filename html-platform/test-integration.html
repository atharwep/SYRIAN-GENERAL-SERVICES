<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙƒØ§Ù…Ù„ - Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 50px auto;
            padding: 30px;
        }

        .test-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-rgba);
        }

        .test-section h2 {
            color: var(--gold);
            margin-bottom: 20px;
        }

        .test-btn {
            background: linear-gradient(135deg, var(--gold), #d4a017);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            margin: 5px;
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(197, 160, 33, 0.3);
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #10b981;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1 style="text-align: center; color: var(--gold); margin-bottom: 40px;">
            ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ù…Ù„
        </h1>

        <!-- Firebase Test -->
        <div class="test-section">
            <h2>ğŸ”¥ Ø§Ø®ØªØ¨Ø§Ø± Firebase</h2>
            <button class="test-btn" onclick="testFirebaseConnection()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
            <button class="test-btn" onclick="testFirebaseSaveUser()">Ø­ÙØ¸ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
            <button class="test-btn" onclick="testFirebaseGetUser()">Ø¬Ù„Ø¨ Ù…Ø³ØªØ®Ø¯Ù…</button>
            <div id="firebase-result" class="test-result" style="display: none;"></div>
        </div>

        <!-- Twilio Test -->
        <div class="test-section">
            <h2>ğŸ“± Ø§Ø®ØªØ¨Ø§Ø± Twilio SMS</h2>
            <input type="text" id="test-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0936020439)"
                style="padding: 10px; border-radius: 8px; border: 1px solid var(--border-rgba); background: rgba(255,255,255,0.05); color: white; margin-bottom: 10px; width: 300px;">
            <br>
            <button class="test-btn" onclick="testTwilioConfig()">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="test-btn" onclick="testSendOTP()">Ø¥Ø±Ø³Ø§Ù„ OTP</button>
            <button class="test-btn" onclick="testSendSMS()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
            <div id="twilio-result" class="test-result" style="display: none;"></div>
        </div>

        <!-- Security Test -->
        <div class="test-section">
            <h2>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù†</h2>
            <button class="test-btn" onclick="testPasswordHashing()">ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
            <button class="test-btn" onclick="testJWTGeneration()">Ø¥Ù†Ø´Ø§Ø¡ JWT Token</button>
            <button class="test-btn" onclick="testRateLimiting()">Ø§Ø®ØªØ¨Ø§Ø± Rate Limiting</button>
            <button class="test-btn" onclick="testInputSanitization()">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</button>
            <div id="security-result" class="test-result" style="display: none;"></div>
        </div>

        <!-- Integration Test -->
        <div class="test-section">
            <h2>ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</h2>
            <button class="test-btn" onclick="testFullRegistration()">ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ§Ù…Ù„</button>
            <button class="test-btn" onclick="testFullLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒØ§Ù…Ù„</button>
            <button class="test-btn" onclick="testTransaction()">Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø§Ù„ÙŠØ©</button>
            <div id="integration-result" class="test-result" style="display: none;"></div>
        </div>

        <!-- System Status -->
        <div class="test-section">
            <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
            <button class="test-btn" onclick="checkSystemStatus()">ÙØ­Øµ Ø´Ø§Ù…Ù„</button>
            <div id="status-result" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Load all scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script src="js/config.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/security.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/twilio-sms.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Helper function to display results
        function showResult(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = `test-result ${type}`;
            el.textContent = message;
        }

        // ===================================
        // Firebase Tests
        // ===================================
        function testFirebaseConnection() {
            try {
                if (typeof firebase !== 'undefined' && firebaseDB) {
                    showResult('firebase-result', 'âœ… Firebase Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„ØªÙØ§ØµÙŠÙ„:\n' +
                        `- Project ID: ${firebaseConfig.projectId}\n` +
                        `- Database URL: ${firebaseConfig.databaseURL}`, 'success');
                } else {
                    showResult('firebase-result', 'âŒ Firebase ØºÙŠØ± Ù…ØªØµÙ„\n\nØªØ£ÙƒØ¯ Ù…Ù†:\n1. ØªØ­Ø¯ÙŠØ« firebase-config.js\n2. ØªØ­Ù…ÙŠÙ„ Firebase SDK', 'error');
                }
            } catch (error) {
                showResult('firebase-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        async function testFirebaseSaveUser() {
            try {
                const testUser = {
                    id: Date.now(),
                    name: "Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ",
                    phone: "0900000000",
                    password: "test123",
                    role: "USER",
                    balanceUSD: 100,
                    balanceSYP: 500000
                };

                const result = await HybridStore.saveUser(testUser);
                showResult('firebase-result', 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!\n\n' +
                    JSON.stringify(testUser, null, 2), 'success');
            } catch (error) {
                showResult('firebase-result', 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'error');
            }
        }

        async function testFirebaseGetUser() {
            try {
                const user = await HybridStore.getUser("0900000000");
                if (user) {
                    showResult('firebase-result', 'âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n\n' +
                        JSON.stringify(user, null, 2), 'success');
                } else {
                    showResult('firebase-result', 'âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯\n\nØ¬Ø±Ø¨ Ø­ÙØ¸ Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹', 'info');
                }
            } catch (error) {
                showResult('firebase-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        // ===================================
        // Twilio Tests
        // ===================================
        async function testTwilioConfig() {
            try {
                const result = await TwilioSMS.verifyConfig();
                if (result.valid) {
                    showResult('twilio-result', 'âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Twilio ØµØ­ÙŠØ­Ø©!\n\nØ§Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'success');
                } else {
                    showResult('twilio-result', 'âŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Twilio ØºÙŠØ± ØµØ­ÙŠØ­Ø©\n\n' +
                        'ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ«:\n1. Account SID\n2. Auth Token\n3. Phone Number', 'error');
                }
            } catch (error) {
                showResult('twilio-result', 'âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±\n\nTwilio ØºÙŠØ± Ù…ÙØ¹Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', 'info');
            }
        }

        async function testSendOTP() {
            const phone = document.getElementById('test-phone').value || '0936020439';
            try {
                const result = await EnhancedSMS.sendOTP(phone);
                showResult('twilio-result',
                    result.success ?
                        `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ OTP!\n\nØ§Ù„ÙˆØ¶Ø¹: ${result.mode || 'simulation'}\n${result.simulated ? 'Ø§Ù„Ø±Ù…Ø²: ' + result.code : ''}` :
                        'âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + result.message,
                    result.success ? 'success' : 'error'
                );
            } catch (error) {
                showResult('twilio-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        async function testSendSMS() {
            const phone = document.getElementById('test-phone').value || '0936020439';
            try {
                const result = await EnhancedSMS.send(phone, 'Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ ğŸ‰');
                showResult('twilio-result',
                    result.success ?
                        'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!' :
                        'âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',
                    result.success ? 'success' : 'error'
                );
            } catch (error) {
                showResult('twilio-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        // ===================================
        // Security Tests
        // ===================================
        async function testPasswordHashing() {
            try {
                const password = "test123";
                const hash = await SecurityManager.hashPassword(password);
                const isValid = await SecurityManager.verifyPassword(password, hash);

                showResult('security-result',
                    `âœ… ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:\n\n` +
                    `Ø§Ù„Ø£ØµÙ„ÙŠØ©: ${password}\n` +
                    `Ø§Ù„Ù…Ø´ÙØ±Ø©: ${hash.substring(0, 50)}...\n` +
                    `Ø§Ù„ØªØ­Ù‚Ù‚: ${isValid ? 'âœ… ØµØ­ÙŠØ­' : 'âŒ Ø®Ø·Ø£'}`,
                    'success'
                );
            } catch (error) {
                showResult('security-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        function testJWTGeneration() {
            try {
                const userData = { id: 1, phone: '0936020439', role: 'ADMIN' };
                const token = SecurityManager.generateToken(userData);
                const verification = SecurityManager.verifyToken(token);

                showResult('security-result',
                    `âœ… JWT Token:\n\n` +
                    `Token: ${token.substring(0, 50)}...\n\n` +
                    `Ø§Ù„ØªØ­Ù‚Ù‚: ${verification.valid ? 'âœ… ØµØ§Ù„Ø­' : 'âŒ ØºÙŠØ± ØµØ§Ù„Ø­'}\n` +
                    `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${JSON.stringify(verification.payload, null, 2)}`,
                    verification.valid ? 'success' : 'error'
                );
            } catch (error) {
                showResult('security-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        function testRateLimiting() {
            try {
                let results = '';
                for (let i = 1; i <= 7; i++) {
                    const check = SecurityManager.rateLimiter.checkLimit('test-user', 5);
                    results += `Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${i}: ${check.allowed ? 'âœ… Ù…Ø³Ù…ÙˆØ­' : 'âŒ Ù…Ø­Ø¸ÙˆØ± (' + check.remainingTime + 'Ø«)'}\n`;
                }

                showResult('security-result',
                    `ğŸ›¡ï¸ Ø§Ø®ØªØ¨Ø§Ø± Rate Limiting:\n\n${results}\n` +
                    `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª / 15 Ø¯Ù‚ÙŠÙ‚Ø©`,
                    'success'
                );

                // Reset for next test
                SecurityManager.rateLimiter.reset('test-user');
            } catch (error) {
                showResult('security-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
            }
        }

        function testInputSanitization() {
            try {
                const tests = [
                    { input: '0936020439', type: 'phone', expected: '963936020439' },
                    { input: '<script>alert("XSS")</script>', type: 'string', expected: 'scriptalert("XSS")/script' },
    { input: '123.45abc', type: 'number', expected: 123.45 }
    ];

    let results = '';
    tests.forEach(test => {
    let cleaned;
    if (test.type === 'phone') cleaned = SecurityManager.sanitize.phone(test.input);
    else if (test.type === 'string') cleaned = SecurityManager.sanitize.string(test.input);
    else if (test.type === 'number') cleaned = SecurityManager.sanitize.number(test.input);

    results += `${test.type}: "${test.input}" â†’ "${cleaned}"\n`;
    });

    showResult('security-result', `âœ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª:\n\n${results}`, 'success');
    } catch (error) {
    showResult('security-result', 'âŒ Ø®Ø·Ø£: ' + error.message, 'error');
    }
    }

    // ===================================
    // Integration Tests
    // ===================================
    async function testFullRegistration() {
    try {
    const password = "test123";
    const hashedPassword = await SecurityManager.hashPassword(password);

    const userData = {
    id: Date.now(),
    name: "Ù…Ø³ØªØ®Ø¯Ù… ØªÙƒØ§Ù…Ù„",
    phone: "0911111111",
    password: hashedPassword,
    role: "USER",
    balanceUSD: 0,
    balanceSYP: 0
    };

    // Save to Firebase
    await HybridStore.saveUser(userData);

    // Generate token
    const token = SecurityManager.generateToken(userData);
    SecurityManager.saveSession(token, userData);

    showResult('integration-result',
    `âœ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù†Ø§Ø¬Ø­!\n\n` +
    `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userData.name}\n` +
    `Ø§Ù„Ù‡Ø§ØªÙ: ${userData.phone}\n` +
    `Token: ${token.substring(0, 30)}...\n` +
    `Ø§Ù„Ø¬Ù„Ø³Ø©: Ù…Ø­ÙÙˆØ¸Ø©`,
    'success'
    );
    } catch (error) {
    showResult('integration-result', 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message, 'error');
    }
    }

    async function testFullLogin() {
    try {
    const phone = "0911111111";
    const password = "test123";

    // Get user
    const user = await HybridStore.getUser(phone);
    if (!user) {
    showResult('integration-result', 'âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯\n\nØ¬Ø±Ø¨ "ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ§Ù…Ù„" Ø£ÙˆÙ„Ø§Ù‹', 'info');
    return;
    }

    // Verify password
    const isValid = await SecurityManager.verifyPassword(password, user.password);
    if (!isValid) {
    showResult('integration-result', 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
    return;
    }

    // Generate token
    const token = SecurityManager.generateToken(user);
    SecurityManager.saveSession(token, user);

    showResult('integration-result',
    `âœ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­!\n\n` +
    `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.name}\n` +
    `Ø§Ù„Ø¯ÙˆØ±: ${user.role}\n` +
    `Ø§Ù„Ø±ØµÙŠØ¯ USD: $${user.balanceUSD}\n` +
    `Ø§Ù„Ø±ØµÙŠØ¯ SYP: ${user.balanceSYP.toLocaleString()} Ù„.Ø³`,
    'success'
    );
    } catch (error) {
    showResult('integration-result', 'âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message, 'error');
    }
    }

    async function testTransaction() {
    showResult('integration-result',
    'âš ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©\n\n' +
    'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØªØ·Ù„Ø¨:\n' +
    '1. Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„\n' +
    '2. Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ\n' +
    '3. Ù…Ø³ØªÙ„Ù… ØµØ§Ù„Ø­\n\n' +
    'Ø§Ø³ØªØ®Ø¯Ù… ØµÙØ­Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„',
    'info'
    );
    }

    // ===================================
    // System Status Check
    // ===================================
    async function checkSystemStatus() {
    let status = 'ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©:\n\n';

    // Firebase
    try {
    if (typeof firebase !== 'undefined' && firebaseDB) {
    status += 'âœ… Firebase: Ù…ØªØµÙ„\n';
    } else {
    status += 'âŒ Firebase: ØºÙŠØ± Ù…ØªØµÙ„\n';
    }
    } catch (e) {
    status += 'âŒ Firebase: Ø®Ø·Ø£\n';
    }

    // Twilio
    try {
    const twilioCheck = await TwilioSMS.verifyConfig();
    status += twilioCheck.valid ? 'âœ… Twilio: Ø¬Ø§Ù‡Ø²\n' : 'âš ï¸ Twilio: ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±\n';
    } catch (e) {
    status += 'âš ï¸ Twilio: ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±\n';
    }

    // Security
    try {
    const testToken = SecurityManager.generateToken({ id: 1 });
    const verification = SecurityManager.verifyToken(testToken);
    status += verification.valid ? 'âœ… Security: ÙŠØ¹Ù…Ù„\n' : 'âŒ Security: Ø®Ø·Ø£\n';
    } catch (e) {
    status += 'âŒ Security: Ø®Ø·Ø£\n';
    }

    // LocalStorage
    try {
    localStorage.setItem('test', 'test');
    localStorage.removeItem('test');
    status += 'âœ… LocalStorage: ÙŠØ¹Ù…Ù„\n';
    } catch (e) {
    status += 'âŒ LocalStorage: Ù…Ø¹Ø·Ù„\n';
    }

    status += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    status += 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…! ğŸš€';

    showResult('status-result', status, 'success');
    }
    </script>
</body>

</html>